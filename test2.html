<style>
  /* Page background */
  html, body {
    background: #f3f3fe;
    margin: 0;
    padding: 0;
  }

  /* Main wrapper */
  #bc-wrap {
    width: min(900px, 92%);
    margin: 36px auto 60px auto; /* more top margin */
  }

  /* Shared card style */
  .bc-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    padding: 18px;
  }

  /* Header row */
  .bc-header {
    display: flex;
    gap: 14px;
    align-items: center;
  }

  #bc-logo {
    display: none;
    max-height: 56px;
    max-width: 220px;
  }

  #bc-business {
    margin: 0;
  }

  /* Offer image */
  #bc-image {
    display: none;
    width: 100%;
    max-height: 340px;
    object-fit: cover;
    border-radius: 12px;
    margin-top: 12px;
  }

  /* Fine print */
  #bc-fine {
    font-size: 12px;
    color: #4b5563;
    margin-top: 12px;
    white-space: pre-wrap;
  }

  /* Notes */
  #bc-note {
    display: none;
    background: #fff7ed;
    border: 1px solid #fed7aa;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 12px;
  }

  /* Divider */
  .bc-hr {
    margin: 18px 0;
    border: none;
    border-top: 1px solid #e5e7eb;
  }

  /* Form card wrapper */
  #bc-form-card {
    margin-top: 16px;
  }

  /* Loading skeleton */
  #bc-form-loading {
    border-radius: 12px;
    padding: 14px;
    background: #f8fafc;
    border: 1px solid #e5e7eb;
  }
  .sk-line {
    height: 14px;
    border-radius: 8px;
    background: linear-gradient(90deg, #eef2ff 25%, #e5e7eb 37%, #eef2ff 63%);
    background-size: 400% 100%;
    animation: shimmer 1.1s infinite;
    margin: 10px 0;
  }
  .sk-line.w60 { width: 60%; }
  .sk-line.w80 { width: 80%; }
  .sk-line.w95 { width: 95%; }

  @keyframes shimmer {
    0% { background-position: 100% 0; }
    100% { background-position: 0 0; }
  }

  /* Fade in form */
  #jf-wrap {
    opacity: 0;
    transition: opacity 240ms ease;
  }
  #jf-wrap.ready {
    opacity: 1;
  }
</style>

<div id="bc-wrap">
  <div id="bc-note"></div>

  <!-- Offer / Business info -->
  <div class="bc-card">
    <div class="bc-header">
      <img id="bc-logo" alt="Business logo" />
      <h1 id="bc-business">Loadingâ€¦</h1>
    </div>

    <h2 id="bc-title" style="margin:12px 0 6px 0;"></h2>
    <p id="bc-desc" style="margin:0;white-space:pre-wrap;"></p>

    <img id="bc-image" alt="Offer image" />

    <div id="bc-fine"></div>
  </div>

  <!-- Form (same design language) -->
  <div id="bc-form-card" class="bc-card">
    <h3 style="margin:0 0 10px 0;">Sign up</h3>

    <div id="bc-form-loading">
      <div class="sk-line w60"></div>
      <div class="sk-line w95"></div>
      <div class="sk-line w80"></div>
      <div class="sk-line w95"></div>
      <div class="sk-line w80"></div>
    </div>

    <div id="jf-wrap"></div>
  </div>
</div>

<script>
  // ========= EDIT THESE =========
  const PD_GET_BUSINESS_URL = "https://eompxe9l4vf4e3z.m.pipedream.net/get-business"; // must return JSON
  const JOTFORM_FORM_ID = "260478526701055";
  const JOTFORM_BUSINESS_ID_FIELD = "bid";     // your hidden field unique name
  const JOTFORM_SOURCE_FIELD = "source";       // your hidden field unique name
  // ==============================

  function qs(name) {
    return new URLSearchParams(window.location.search).get(name);
  }
  function showNote(msg) {
    const el = document.getElementById("bc-note");
    el.style.display = "block";
    el.textContent = msg;
  }
  function setText(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text || "";
  }
  function setImg(id, url) {
    const el = document.getElementById(id);
    if (!el) return;
    if (url) {
      el.src = url;
      el.style.display = "block";
    } else {
      el.style.display = "none";
    }
  }

  async function loadBusiness(businessId) {
    const res = await fetch(PD_GET_BUSINESS_URL + "?b=" + encodeURIComponent(businessId), { cache: "no-store" });

    if (!res.ok) {
      const t = await res.text().catch(() => "");
      throw new Error("Business lookup failed (HTTP " + res.status + "). " + (t ? ("Body: " + t.slice(0,120)) : ""));
    }

    const txt = await res.text();
    let cfg;
    try { cfg = JSON.parse(txt); }
    catch { throw new Error("Endpoint did not return JSON. First 80 chars: " + txt.slice(0,80)); }

    return cfg;
  }

  function embedJotform(businessId) {
    const source = window.location.href;

    const s = document.createElement("script");
    s.type = "text/javascript";

    const src = new URL("https://form.jotform.com/jsform/" + JOTFORM_FORM_ID);
    if (businessId) src.searchParams.set(JOTFORM_BUSINESS_ID_FIELD, businessId);
    src.searchParams.set(JOTFORM_SOURCE_FIELD, source);

    s.src = src.toString();

    const wrap = document.getElementById("jf-wrap");
    wrap.appendChild(s);

    // jsform loads async; we fade in after a short delay + also on load event
    setTimeout(() => {
      document.getElementById("bc-form-loading").style.display = "none";
      wrap.classList.add("ready");
    }, 800);

    s.addEventListener("load", () => {
      document.getElementById("bc-form-loading").style.display = "none";
      wrap.classList.add("ready");
    });
  }

  (async function init() {
    const businessId = qs("b") || "";

    if (!businessId) {
      setText("bc-business", "Missing business ID");
      showNote("Use: /signup?b=YOUR_BUSINESS_ID");
      embedJotform("");
      return;
    }

    embedJotform(businessId);

    try {
      const cfg = await loadBusiness(businessId);

      if (cfg.status && cfg.status !== "active") {
        showNote("This birthday club is currently unavailable.");
      }

      setText("bc-business", (cfg.business_name || "Birthday Club") + " Birthday Club");
      setImg("bc-logo", cfg.logo_url);

      setText("bc-title", cfg.offer_title || "");
      setText("bc-desc", cfg.offer_description || "");
      setImg("bc-image", cfg.offer_image_url);

      setText("bc-fine", cfg.fine_print || "");
    } catch (e) {
      console.error(e);
      setText("bc-business", "Birthday Club");
      showNote(e.message || "We couldn't load this business's offer. Please try again later.");
    }
  })();
</script>
