<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Birthday Club Signup</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 24px; max-width: 820px; }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 18px; }
    img.logo { max-height: 56px; max-width: 220px; }
    img.offer { width: 100%; max-height: 340px; object-fit: cover; border-radius: 12px; margin-top: 12px; }
    .fine { font-size: 12px; color: #4b5563; margin-top: 12px; white-space: pre-wrap; }
    .note { background: #fff7ed; border: 1px solid #fed7aa; padding: 12px; border-radius: 10px; margin-bottom: 12px; }
  </style>
</head>
<body>
  <div class="card">
    <div id="note" class="note" style="display:none;"></div>

    <header style="display:flex;gap:14px;align-items:center;margin-top:6px;">
      <img id="logo" class="logo" alt="" style="display:none;" />
      <h1 id="business_name" style="margin:0;">Loading…</h1>
    </header>

    <section style="margin-top:10px;">
      <h2 id="offer_title" style="margin-bottom:6px;"></h2>
      <p id="offer_description" style="margin-top:0;white-space:pre-wrap;"></p>
      <img id="offer_image" class="offer" alt="" style="display:none;" />
      <div id="fine_print" class="fine"></div>
    </section>

    <hr style="margin:18px 0;border:none;border-top:1px solid #e5e7eb;" />

    <section>
      <h3 style="margin-top:0;">Sign up</h3>
      <iframe id="jf" title="Birthday Club Signup" style="width:100%;height:720px;border:none;"></iframe>
    </section>
  </div>

  <script>
    // ✅ EDIT THESE:
    const PIPEDREAM_GET_BUSINESS_URL = "https://eompxe9l4vf4e3z.m.pipedream.net/get-business";
    const JOTFORM_CUSTOMER_FORM_URL  = "https://form.jotform.com/260478526701055";

    // ✅ If your Jotform hidden fields have different names, change these:
    const JOTFORM_BUSINESS_ID_FIELD = "business_id";
    const JOTFORM_SOURCE_FIELD      = "source";

    function showNote(msg) {
      const el = document.getElementById("note");
      el.style.display = "block";
      el.textContent = msg;
    }

    (function () {
      const params = new URLSearchParams(window.location.search);
      const businessId = params.get("b");
      if (!businessId) {
        document.getElementById("business_name").textContent = "Missing business ID";
        showNote("Use: /signup.html?b=YOUR_BUSINESS_ID");
        return;
      }

      // Prefill Jotform via query params
      const formUrl = new URL(JOTFORM_CUSTOMER_FORM_URL);
      formUrl.searchParams.set(JOTFORM_BUSINESS_ID_FIELD, businessId);
      formUrl.searchParams.set(JOTFORM_SOURCE_FIELD, window.location.href);
      document.getElementById("jf").src = formUrl.toString();

      // Load business config for rendering
      fetch(PIPEDREAM_GET_BUSINESS_URL + "?b=" + encodeURIComponent(businessId))
        .then(r => r.json())
        .then(cfg => {
          if (cfg.status && cfg.status !== "active") {
            showNote("This birthday club is currently unavailable.");
          }
          document.getElementById("business_name").textContent = (cfg.business_name || "Birthday Club") + " Birthday Club";

          if (cfg.logo_url) {
            const logo = document.getElementById("logo");
            logo.src = cfg.logo_url;
            logo.style.display = "block";
          }
          document.getElementById("offer_title").textContent = cfg.offer_title || "";
          document.getElementById("offer_description").textContent = cfg.offer_description || "";

          if (cfg.offer_image_url) {
            const img = document.getElementById("offer_image");
            img.src = cfg.offer_image_url;
            img.style.display = "block";
          }
          document.getElementById("fine_print").textContent = cfg.fine_print || "";
        })
        .catch(err => {
          console.error(err);
          document.getElementById("business_name").textContent = "Error loading offer";
          showNote("We couldn't load this business's offer. Please try again later.");
        });
    })();
  </script>
</body>
</html>
