<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Birthday Club Signup</title>
    <link rel="stylesheet" href="./assets/styles.css" />
  </head>

  <body>
    <!-- Loading (Balloon spinner) -->
    <div id="bc-loading" aria-live="polite">
      <div class="bc-balloon-spinner" aria-hidden="true">
        <span class="bc-b bc-b1"></span>
        <span class="bc-b bc-b2"></span>
        <span class="bc-b bc-b3"></span>
      </div>
      <div id="bc-loading-text">Loading this business’s birthday club…</div>
    </div>

    <!-- Background balloons (behind content) -->
    <div class="balloons" aria-hidden="true">
      <div
        class="balloon"
        style="
          left: 6%;
          animation-duration: 18s;
          animation-delay: -2s;
          transform: scale(0.9);
          background: linear-gradient(180deg, rgba(109, 94, 252, 0.9), rgba(109, 94, 252, 0.35));
        "
      >
        <div class="shine"></div>
      </div>
      <div
        class="balloon"
        style="
          left: 18%;
          animation-duration: 22s;
          animation-delay: -10s;
          transform: scale(1.05);
          background: linear-gradient(180deg, rgba(34, 195, 238, 0.9), rgba(34, 195, 238, 0.35));
        "
      >
        <div class="shine"></div>
      </div>
      <div
        class="balloon"
        style="
          left: 33%;
          animation-duration: 20s;
          animation-delay: -6s;
          transform: scale(0.85);
          background: linear-gradient(180deg, rgba(52, 211, 153, 0.9), rgba(52, 211, 153, 0.35));
        "
      >
        <div class="shine"></div>
      </div>
      <div
        class="balloon"
        style="
          left: 47%;
          animation-duration: 26s;
          animation-delay: -14s;
          transform: scale(1.1);
          background: linear-gradient(180deg, rgba(245, 158, 11, 0.85), rgba(245, 158, 11, 0.3));
        "
      >
        <div class="shine"></div>
      </div>
      <div
        class="balloon"
        style="
          left: 62%;
          animation-duration: 24s;
          animation-delay: -8s;
          transform: scale(0.95);
          background: linear-gradient(180deg, rgba(236, 72, 153, 0.85), rgba(236, 72, 153, 0.3));
        "
      >
        <div class="shine"></div>
      </div>
      <div
        class="balloon mobile-hide"
        style="
          left: 74%;
          animation-duration: 28s;
          animation-delay: -16s;
          transform: scale(1.15);
          background: linear-gradient(180deg, rgba(99, 102, 241, 0.85), rgba(99, 102, 241, 0.28));
        "
      >
        <div class="shine"></div>
      </div>
      <div
        class="balloon mobile-hide"
        style="
          left: 86%;
          animation-duration: 21s;
          animation-delay: -4s;
          transform: scale(0.88);
          background: linear-gradient(180deg, rgba(14, 165, 233, 0.85), rgba(14, 165, 233, 0.28));
        "
      >
        <div class="shine"></div>
      </div>
      <div
        class="balloon mobile-hide"
        style="
          left: 92%;
          animation-duration: 30s;
          animation-delay: -20s;
          transform: scale(1.22);
          background: linear-gradient(180deg, rgba(34, 197, 94, 0.8), rgba(34, 197, 94, 0.25));
        "
      >
        <div class="shine"></div>
      </div>
    </div>

    <div id="bc-wrap">
      <!-- Business verification section -->
      <div id="biz">
        <h1 id="biz_name">Loading business...</h1>
        <div>
          <img id="biz_logo" alt="Business logo" />
        </div>
        <h2 id="offer_title"></h2>
        <p id="offer_desc"></p>
        <div>
          <img id="offer_img" alt="Offer image" />
        </div>
        <p id="fine_print"></p>
        <div id="biz_note"></div>
        <hr />
      </div>

      <!-- Choose ONE embed method below by setting EMBED_MODE:
           "direct" | "jsform" | "iframe"
      -->
      <div id="form_area"></div>
    </div>

    <script>
      // ===================== CONFIG =====================
      const S3_BUCKET = 'birthdayclub-public';
      const S3_REGION = 'us-west-2';
      const S3_PREFIX = 'businesses/';

      const JOTFORM_DIRECT_URL = 'https://form.jotform.com/mpgreco6/customer-birthday-club-signup';
      const JOTFORM_JSFORM_SCRIPT = 'https://form.jotform.com/jsform/260478526701055';
      const JOTFORM_IFRAME_ID = 'JotFormIFrame-260478526701055';

      // "direct" | "jsform" | "iframe"
      const EMBED_MODE = 'iframe';

      // Jotform hidden field unique names
      const JOTFORM_BID_FIELD = 'bid';
      const JOTFORM_SOURCE_FIELD = 'source';
      // ==================================================

      function qs(name) {
        return new URLSearchParams(window.location.search).get(name);
      }

      // Loading controls
      function showLoading(msg) {
        const l = document.getElementById('bc-loading');
        const t = document.getElementById('bc-loading-text');
        if (t && msg) t.textContent = msg;
        if (l) l.style.display = 'flex';

        const wrap = document.getElementById('bc-wrap');
        if (wrap) wrap.style.display = 'none';
      }

      function showContent() {
        const l = document.getElementById('bc-loading');
        if (l) l.style.display = 'none';

        const wrap = document.getElementById('bc-wrap');
        if (wrap) wrap.style.display = 'block';
      }

      function setText(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text || '';
      }

      function setImg(id, url) {
        const el = document.getElementById(id);
        if (!el) return;

        // Clear any previous handlers
        el.onload = null;
        el.onerror = null;

        if (!url || typeof url !== 'string') {
          el.removeAttribute('src');
          el.style.display = 'none';
          return;
        }

        // If the host blocks hotlinking, this will fail; we handle it in onerror
        el.style.display = ''; // show the <img> element
        el.src = url;

        el.onload = () => {
          // ensure visible after load
          el.style.display = '';
        };

        el.onerror = () => {
          console.warn('Image failed to load:', url);
          el.style.display = 'none';

          // Optional: show a text fallback for the logo
          if (id === 'biz_logo') {
            const name = document.getElementById('biz_name');
            if (name)
              name.textContent = (name.textContent || '').replace('Loading business...', '').trim();
          }
        };
      }

      function setNote(msg) {
        const el = document.getElementById('biz_note');
        if (!el) return;
        el.textContent = msg || '';
      }

      function getBusinessJsonUrl(businessId) {
        return `https://${S3_BUCKET}.s3.${S3_REGION}.amazonaws.com/${S3_PREFIX}${encodeURIComponent(businessId)}.json`;
      }

      async function loadBusiness(businessId) {
        const url = getBusinessJsonUrl(businessId);
        console.log('Fetching business JSON:', url);

        const res = await fetch(url, { method: 'GET', mode: 'cors', cache: 'default' });
        if (!res.ok) {
          const t = await res.text().catch(() => '');
          throw new Error(
            `Business JSON fetch failed (HTTP ${res.status}). ${t ? 'Body: ' + t.slice(0, 120) : ''}`,
          );
        }
        return await res.json();
      }

      function buildJotformUrlWithPrefill(baseUrl, businessId) {
        const u = new URL(baseUrl);
        if (businessId) u.searchParams.set(JOTFORM_BID_FIELD, businessId);
        u.searchParams.set(JOTFORM_SOURCE_FIELD, window.location.href);
        u.searchParams.set('isMobile', '1');
        return u.toString();
      }

      function ensureFormEmbedded(businessId) {
        const formArea = document.getElementById('form_area');
        if (!formArea) return;

        // prevent accidental double-embed
        if (formArea.dataset.embedded === '1') return;
        formArea.dataset.embedded = '1';

        if (EMBED_MODE === 'direct') renderDirectLink(businessId);
        if (EMBED_MODE === 'jsform') renderJsformEmbed(businessId);
        if (EMBED_MODE === 'iframe') renderIframeEmbed(businessId);
      }

      function renderDirectLink(businessId) {
        const formArea = document.getElementById('form_area');
        const url = buildJotformUrlWithPrefill(JOTFORM_DIRECT_URL, businessId);

        const p = document.createElement('p');
        p.textContent = 'Open the signup form:';

        const a = document.createElement('a');
        a.href = url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = url;

        formArea.appendChild(p);
        formArea.appendChild(a);
      }

      function renderJsformEmbed(businessId) {
        const formArea = document.getElementById('form_area');
        const script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = buildJotformUrlWithPrefill(JOTFORM_JSFORM_SCRIPT, businessId);
        formArea.appendChild(script);
      }

      function renderIframeEmbed(businessId) {
        const formArea = document.getElementById('form_area');
        const src = buildJotformUrlWithPrefill(JOTFORM_DIRECT_URL, businessId);

        const iframe = document.createElement('iframe');
        iframe.id = JOTFORM_IFRAME_ID;
        iframe.title = 'Customer Birthday Club Signup';
        iframe.setAttribute('allowtransparency', 'true');
        iframe.setAttribute('allow', 'geolocation; microphone; camera; fullscreen; payment');
        iframe.setAttribute('frameborder', '0');
        iframe.setAttribute('scrolling', window.innerWidth <= 640 ? 'yes' : 'no');

        iframe.style.minWidth = '100%';
        iframe.style.maxWidth = '100%';
        iframe.style.height = '539px';
        iframe.style.border = 'none';
        iframe.src = src;

        formArea.appendChild(iframe);

        const handler = document.createElement('script');
        handler.src = 'https://cdn.jotfor.ms/s/umd/latest/for-form-embed-handler.js';
        handler.onload = function () {
          if (window.jotformEmbedHandler) {
            window.jotformEmbedHandler(
              "iframe[id='" + JOTFORM_IFRAME_ID + "']",
              'https://form.jotform.com/',
            );
          }
        };
        document.body.appendChild(handler);
      }

      // --- helper: wait for a promise with timeout ---
      function withTimeout(promise, ms, label = 'operation') {
        let t;
        const timeout = new Promise((_, rej) => {
          t = setTimeout(() => rej(new Error(`Timeout waiting for ${label} (${ms}ms)`)), ms);
        });
        return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
      }

      // --- embed form and return a Promise when it’s ready ---
      function embedFormAndWait(businessId) {
        const formArea = document.getElementById('form_area');
        if (!formArea) return Promise.resolve();

        // clear & re-embed (prevents duplicates)
        formArea.innerHTML = '';

        if (EMBED_MODE === 'iframe') {
          return new Promise((resolve) => {
            const src = buildJotformUrlWithPrefill(JOTFORM_DIRECT_URL, businessId);

            const iframe = document.createElement('iframe');
            iframe.id = JOTFORM_IFRAME_ID;
            iframe.title = 'Customer Birthday Club Signup';
            iframe.setAttribute('allowtransparency', 'true');
            iframe.setAttribute('allow', 'geolocation; microphone; camera; fullscreen; payment');
            iframe.setAttribute('frameborder', '0');
            iframe.setAttribute('scrolling', window.innerWidth <= 640 ? 'yes' : 'no');
            iframe.style.minWidth = '100%';
            iframe.style.maxWidth = '100%';
            iframe.style.height = '539px';
            iframe.style.border = 'none';
            iframe.src = src;

            iframe.onload = () => resolve(); // ✅ reliable

            formArea.appendChild(iframe);

            // optional: jotform resize handler (doesn't affect "ready")
            const handler = document.createElement('script');
            handler.src = 'https://cdn.jotfor.ms/s/umd/latest/for-form-embed-handler.js';
            handler.onload = function () {
              if (window.jotformEmbedHandler) {
                window.jotformEmbedHandler(
                  "iframe[id='" + JOTFORM_IFRAME_ID + "']",
                  'https://form.jotform.com/',
                );
              }
            };
            document.body.appendChild(handler);
          });
        }

        if (EMBED_MODE === 'jsform') {
          // "Best effort": resolve after script loads + brief delay so DOM inject occurs
          return new Promise((resolve) => {
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = buildJotformUrlWithPrefill(JOTFORM_JSFORM_SCRIPT, businessId);
            script.onload = () => setTimeout(resolve, 600);
            script.onerror = () => resolve(); // don't block forever
            formArea.appendChild(script);

            // safety: even if onload never fires
            setTimeout(resolve, 2500);
          });
        }

        // direct link = instant
        if (EMBED_MODE === 'direct') {
          renderDirectLink(businessId);
          return Promise.resolve();
        }

        return Promise.resolve();
      }

      (async function init() {
        const businessId = qs('b') || '';
        showLoading();

        try {
          if (!businessId) {
            setText('biz_name', 'Birthday Club Signup');
            setNote('Missing business id in URL. Use: /signup?b=BUSINESS_ID');
            setImg('biz_logo', 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSbATUhngz1vyO6op5JXFgYRyVV7nzhS2Dpsg&s');
            setImg('offer_img', '');
            // still show form
            await withTimeout(embedFormAndWait(''), 5000, 'form load');
            return;
          }

          // Load business JSON
          try {
            const cfg = await withTimeout(loadBusiness(businessId), 3500, 'business data');

            if (cfg.status && cfg.status !== 'active') {
              setNote(
                'Note: This birthday club is currently unavailable (status: ' + cfg.status + ').',
              );
            } else setNote('');

            setText('biz_name', (cfg.business_name || 'Birthday Club') + ' Birthday Club');
            setImg('biz_logo', cfg.logo_url || '');
            setText('offer_title', cfg.offer_title || '');
            setText('offer_desc', cfg.offer_description || '');
            setImg('offer_img', cfg.offer_image_url || '');
            setText('fine_print', cfg.fine_print || '');
          } catch (e) {
            // business fetch failed, but still allow signup
            setText('biz_name', 'Birthday Club Signup');
            setNote('Could not load business offer info.');
            setImg('biz_logo', '');
            setImg('offer_img', '');
          }

          // Now load the form and WAIT for it
          await withTimeout(embedFormAndWait(businessId), 7000, 'form load');
        } finally {
          // ✅ only reveal once both steps are done (or timed out)
          showContent();
        }
      })();
    </script>
  </body>
</html>
