<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Birthday Club Signup</title>
  </head>

  <body>
    <!--
      PURPOSE:
      - A single, no-CSS baseline page that:
        1) Reads ?b=BUSINESS_ID from the URL
        2) Fetches business offer info from Pipedream
        3) Shows business name/logo/offer at the top so customers can verify they’re signing up for the right business
        4) Embeds the Jotform in one of three ways (direct link, jsform, iframe)

      REQUIRED URL PARAM:
        /signup?b=123

      NOTE:
      - Replace PD_GET_BUSINESS_URL with your real endpoint.
      - This assumes your Pipedream endpoint returns JSON like:
        {
          "status":"active",
          "business_name":"Test Business",
          "logo_url":"",
          "offer_title":"Free birthday item",
          "offer_description":"Show this message in-store.",
          "offer_image_url":"",
          "fine_print":"Valid 7 days."
        }

      JOTFORM PREFILL:
      - If you want Jotform to receive the business id, add hidden fields in Jotform:
          bid  (business id)
          source
      - This page will append ?bid=...&source=... to direct link + iframe, and for jsform it appends to the script src.
    -->

    <!-- Business verification section -->
    <div id="biz">
      <h1 id="biz_name">Loading business...</h1>
      <div>
        <img id="biz_logo" alt="Business logo" />
      </div>
      <h2 id="offer_title"></h2>
      <p id="offer_desc"></p>
      <div>
        <img id="offer_img" alt="Offer image" />
      </div>
      <p id="fine_print"></p>
      <div id="biz_note"></div>
      <hr />
    </div>

    <!-- Choose ONE embed method below by setting EMBED_MODE:
         "direct" | "jsform" | "iframe"
    -->
    <div id="form_area"></div>

    <script>
      // ===================== CONFIG =====================
      // Pipedream endpoint that returns business info as JSON.
      // Example: https://YOUR-ENDPOINT/get-business?b=123
      const PD_GET_BUSINESS_URL = "https://eompxe9l4vf4e3z.m.pipedream.net/get-business";

      // Jotform direct link (as provided)
      const JOTFORM_DIRECT_URL = "https://form.jotform.com/mpgreco6/customer-birthday-club-signup";

      // Jotform jsform embed (as provided)
      const JOTFORM_JSFORM_SCRIPT = "https://form.jotform.com/jsform/260478526701055";

      // Jotform iframe id (as provided)
      const JOTFORM_IFRAME_ID = "JotFormIFrame-260478526701055";

      // Which embed mode to use:
      // "direct" shows a link button (most reliable mobile)
      // "jsform" uses <script src=".../jsform/...">
      // "iframe" uses iframe + jotformEmbedHandler
      const EMBED_MODE = "iframe";

      // Jotform hidden field unique names (change if yours differ)
      const JOTFORM_BID_FIELD = "bid";
      const JOTFORM_SOURCE_FIELD = "source";
      // ==================================================

      function qs(name) {
        return new URLSearchParams(window.location.search).get(name);
      }

      function setText(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text || "";
      }

      function setImg(id, url) {
        const el = document.getElementById(id);
        if (!el) return;
        if (url) {
          el.src = url;
          el.style.display = "";
        } else {
          el.removeAttribute("src");
          el.style.display = "none";
        }
      }

      function setNote(msg) {
        const el = document.getElementById("biz_note");
        if (!el) return;
        el.textContent = msg || "";
      }

      async function loadBusiness(businessId) {
        const res = await fetch(PD_GET_BUSINESS_URL + "?b=" + encodeURIComponent(businessId), { cache: "no-store" });
        const txt = await res.text();
        if (!res.ok) throw new Error("Business lookup failed (HTTP " + res.status + "): " + txt.slice(0, 120));
        try {
          return JSON.parse(txt);
        } catch (e) {
          throw new Error("Pipedream did not return JSON. First 80 chars: " + txt.slice(0, 80));
        }
      }

      function buildJotformUrlWithPrefill(baseUrl, businessId) {
        const u = new URL(baseUrl);
        if (businessId) u.searchParams.set(JOTFORM_BID_FIELD, businessId);
        u.searchParams.set(JOTFORM_SOURCE_FIELD, window.location.href);
        return u.toString();
      }

      function renderDirectLink(businessId) {
        const formArea = document.getElementById("form_area");
        const url = buildJotformUrlWithPrefill(JOTFORM_DIRECT_URL, businessId);

        const p = document.createElement("p");
        p.textContent = "Open the signup form:";

        const a = document.createElement("a");
        a.href = url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = url;

        formArea.appendChild(p);
        formArea.appendChild(a);
      }

      function renderJsformEmbed(businessId) {
        const formArea = document.getElementById("form_area");
        const script = document.createElement("script");
        script.type = "text/javascript";

        // Add prefill params to the jsform script URL
        // (Jotform typically supports prefill via query params)
        const src = buildJotformUrlWithPrefill(JOTFORM_JSFORM_SCRIPT, businessId);
        script.src = src;

        formArea.appendChild(script);
      }

      function renderIframeEmbed(businessId) {
        const formArea = document.getElementById("form_area");
        const src = buildJotformUrlWithPrefill(JOTFORM_DIRECT_URL, businessId);

        const iframe = document.createElement("iframe");
        iframe.id = JOTFORM_IFRAME_ID;
        iframe.title = "Customer Birthday Club Signup";
        iframe.setAttribute("allowtransparency", "true");
        iframe.setAttribute("allow", "geolocation; microphone; camera; fullscreen; payment");
        iframe.setAttribute("frameborder", "0");
        iframe.setAttribute("scrolling", "no");
        iframe.style.minWidth = "100%";
        iframe.style.maxWidth = "100%";
        iframe.style.height = "539px";
        iframe.style.border = "none";
        iframe.src = src;

        formArea.appendChild(iframe);

        // Load the embed handler and then call it (avoids race conditions)
        const handler = document.createElement("script");
        handler.src = "https://cdn.jotfor.ms/s/umd/latest/for-form-embed-handler.js";
        handler.onload = function () {
          if (window.jotformEmbedHandler) {
            window.jotformEmbedHandler("iframe[id='" + JOTFORM_IFRAME_ID + "']", "https://form.jotform.com/");
          }
        };
        document.body.appendChild(handler);
      }

      (async function init() {
        const businessId = qs("b") || "";

        // Embed the form regardless (so it’s usable even if business data fails)
        if (EMBED_MODE === "direct") renderDirectLink(businessId);
        if (EMBED_MODE === "jsform") renderJsformEmbed(businessId);
        if (EMBED_MODE === "iframe") renderIframeEmbed(businessId);

        // If no business id, still show a warning and stop
        if (!businessId) {
          setText("biz_name", "Birthday Club Signup");
          setNote("Missing business id in URL. Use: /signup?b=BUSINESS_ID");
          setImg("biz_logo", "");
          setImg("offer_img", "");
          return;
        }

        // Load & render business verification info
        try {
          const cfg = await loadBusiness(businessId);

          if (cfg.status && cfg.status !== "active") {
            setNote("Note: This birthday club is currently unavailable (status: " + cfg.status + ").");
          } else {
            setNote("");
          }

          setText("biz_name", (cfg.business_name || "Birthday Club") + " Birthday Club");
          setImg("biz_logo", cfg.logo_url || "");

          setText("offer_title", cfg.offer_title || "");
          setText("offer_desc", cfg.offer_description || "");
          setImg("offer_img", cfg.offer_image_url || "");
          setText("fine_print", cfg.fine_print || "");
        } catch (e) {
          setText("biz_name", "Birthday Club Signup");
          setNote("Could not load business offer info: " + (e && e.message ? e.message : String(e)));
          setImg("biz_logo", "");
          setImg("offer_img", "");
        }
      })();
    </script>
  </body>
</html>
